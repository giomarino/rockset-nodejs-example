"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
/**
 * Generate FEATURE_FLAGS.md, a report of all current feature flags
 */
const fs_1 = require("fs");
const path = require("path");
const feats = require("../lib/features");
const flag_modeling_1 = require("../lib/private/flag-modeling");
async function main() {
    await updateMarkdownFile(path.join(__dirname, '..', 'FEATURE_FLAGS.md'), {
        table: flagsTable(),
        details: flagsDetails(),
        json: recommendedJson(),
        removed: removedFlags(),
        diff: changedFlags(),
        migratejson: migrateJson(),
    });
}
function flagsTable() {
    return renderTable([
        ['Flag', 'Summary', 'Since', 'Type'],
        ...v2flags().map(([name, flag]) => [
            renderLink(mdEsc(name), githubHeadingLink(flagDetailsHeading(name, flag))),
            flag.summary,
            flag.introducedIn.v2 ?? '',
            renderType(flag.type),
        ]),
    ]);
}
function removedFlags() {
    const removedInV2 = flags(flag => flag.introducedIn.v2 === undefined && flag.introducedIn.v1 !== undefined);
    return renderTable([
        ['Flag', 'Summary', 'Type', 'Since'],
        ...removedInV2.map(([name, flag]) => [
            renderLink(mdEsc(name), githubHeadingLink(flagDetailsHeading(name, flag))),
            flag.summary,
            renderType(flag.type),
            flag.introducedIn.v1 ?? '',
        ]),
    ]);
}
function changedFlags() {
    const changedInV2 = flags(flag => !!flag.defaults?.v2 && !!flag.introducedIn.v2);
    return renderTable([
        ['Flag', 'Summary', 'Type', 'Since', 'v1 default', 'v2 default'],
        ...changedInV2.map(([name, flag]) => [
            renderLink(mdEsc(name), githubHeadingLink(flagDetailsHeading(name, flag))),
            flag.summary,
            renderType(flag.type),
            flag.introducedIn.v1 ?? '',
            renderValue(false),
            renderValue(flag.defaults?.v2),
        ]),
    ]);
}
function migrateJson() {
    const changedInV2 = flags(flag => !!flag.defaults?.v2 && !!flag.introducedIn.v2);
    const context = Object.fromEntries(changedInV2.map(([name, _]) => [name, false]));
    return [
        '```json',
        JSON.stringify({ context }, undefined, 2),
        '```',
    ].join('\n');
}
function flagsDetails() {
    const allFlags = flags(_ => true);
    return allFlags.flatMap(([name, flag]) => [
        `### ${flagDetailsHeading(name, flag)}`,
        '',
        `*${flag.summary}* ${renderType(flag.type)}`,
        '',
        dedent(flag.detailsMd),
        '',
        renderTable([
            ['Since', 'Default', 'Recommended'],
            // V1
            flag.introducedIn.v1
                ? [flag.introducedIn.v1, renderValue(false), renderValue(flag.recommendedValue)]
                : ['(not in v1)', '', ''],
            // V2
            flag.introducedIn.v2
                ? [flag.introducedIn.v2, renderValue(flag.defaults?.v2 ?? false), renderValue(flag.recommendedValue)]
                : flag.defaults?.v2 !== undefined
                    ? ['(default in v2)', renderValue(flag.defaults?.v2), '']
                    : ['(not in v2)', '', ''],
        ]),
        ...oldBehavior(flag) ? [
            `**Compatibility with old behavior:** ${oldBehavior(flag)}`,
            '',
        ] : [],
        '',
    ]).join('\n');
}
function oldBehavior(flag) {
    switch (flag.type) {
        case flag_modeling_1.FlagType.ApiDefault: return flag.compatibilityWithOldBehaviorMd;
        case flag_modeling_1.FlagType.BugFix: return flag.compatibilityWithOldBehaviorMd;
        case flag_modeling_1.FlagType.VisibleContext: return undefined;
    }
}
function recommendedJson() {
    return [
        '```json',
        JSON.stringify({ context: feats.NEW_PROJECT_CONTEXT }, undefined, 2),
        '```',
    ].join('\n');
}
function v2flags() {
    return flags(flag => flag.introducedIn.v2 !== undefined);
}
function flags(pred) {
    const entries = Object.entries(feats.FLAGS)
        .filter(([_, flag]) => pred(flag));
    entries.sort((a, b) => firstCmp(
    // Sort by versions first
    flag_modeling_1.compareVersions(a[1].introducedIn.v2, b[1].introducedIn.v2), flag_modeling_1.compareVersions(a[1].introducedIn.v1, b[1].introducedIn.v1), 
    // Then sort by name
    a[0].localeCompare(b[0])));
    return entries;
}
function renderType(type) {
    switch (type) {
        case flag_modeling_1.FlagType.ApiDefault: return '(default)';
        case flag_modeling_1.FlagType.BugFix: return '(fix)';
        case flag_modeling_1.FlagType.VisibleContext: return '(config)';
    }
}
function renderTable(rows) {
    return [
        '',
        '| ' + rows[0].join(' | ') + ' |',
        '| ' + rows[0].map(_ => '-----').join(' | ') + ' |',
        ...rows.slice(1).map(row => '| ' + row.join(' | ') + ' |'),
        '',
    ].join('\n');
}
/**
 * Return the heading that will be used to caption this flag's details
 */
function flagDetailsHeading(name, _) {
    return name;
}
/**
 * Return a link that is valid on GitHub to refer to a heading
 */
function githubHeadingLink(heading) {
    return `#${heading.toLowerCase().replace(/ /g, '-').replace(/[^a-z0-9_-]/g, '')}`;
}
/**
 * Remove shared leading whitespace from all non-empty lines
 */
function dedent(body) {
    const lines = body.split('\n').filter((x) => x.trim() !== '');
    const leadingWs = lines.map(x => x.match(/^ */)?.[0].length ?? 0);
    const sharedWs = Math.min(...leadingWs);
    const re = new RegExp('^' + ' '.repeat(sharedWs), 'mg');
    return body.replace(re, '').trim();
}
function renderValue(x) {
    return `\`${JSON.stringify(x)}\``;
}
function renderLink(caption, link) {
    return `[${caption}](${link})`;
}
function mdEsc(x) {
    return x.replace(/_/g, '\\_');
}
async function updateMarkdownFile(filename, sections) {
    let contents = await fs_1.promises.readFile(filename, { encoding: 'utf-8' });
    for (const [section, value] of Object.entries(sections)) {
        const re = new RegExp(`<!-- BEGIN ${section} -->(.*)<!-- END ${section} -->`, 's');
        contents = contents.replace(re, `<!-- BEGIN ${section} -->\n${value}\n<!-- END ${section} -->`);
    }
    await fs_1.promises.writeFile(filename, contents, { encoding: 'utf-8' });
}
function firstCmp(...xs) {
    return xs.find(x => x !== 0) ?? 0;
}
main().catch(e => {
    // eslint-disable-next-line no-console
    console.error(e);
    process.exitCode = 1;
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmxhZy1yZXBvcnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJmbGFnLXJlcG9ydC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBOztHQUVHO0FBQ0gsMkJBQW9DO0FBQ3BDLDZCQUE2QjtBQUM3Qix5Q0FBeUM7QUFDekMsZ0VBQW1GO0FBRW5GLEtBQUssVUFBVSxJQUFJO0lBQ2pCLE1BQU0sa0JBQWtCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsSUFBSSxFQUFFLGtCQUFrQixDQUFDLEVBQUU7UUFDdkUsS0FBSyxFQUFFLFVBQVUsRUFBRTtRQUNuQixPQUFPLEVBQUUsWUFBWSxFQUFFO1FBQ3ZCLElBQUksRUFBRSxlQUFlLEVBQUU7UUFDdkIsT0FBTyxFQUFFLFlBQVksRUFBRTtRQUN2QixJQUFJLEVBQUUsWUFBWSxFQUFFO1FBQ3BCLFdBQVcsRUFBRSxXQUFXLEVBQUU7S0FDM0IsQ0FBQyxDQUFDO0FBQ0wsQ0FBQztBQUVELFNBQVMsVUFBVTtJQUNqQixPQUFPLFdBQVcsQ0FBQztRQUNqQixDQUFDLE1BQU0sRUFBRSxTQUFTLEVBQUUsT0FBTyxFQUFFLE1BQU0sQ0FBQztRQUNwQyxHQUFHLE9BQU8sRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FDaEM7WUFDRSxVQUFVLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxFQUFFLGlCQUFpQixDQUFDLGtCQUFrQixDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQzFFLElBQUksQ0FBQyxPQUFPO1lBQ1osSUFBSSxDQUFDLFlBQVksQ0FBQyxFQUFFLElBQUksRUFBRTtZQUMxQixVQUFVLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQztTQUN0QixDQUNGO0tBQ0YsQ0FBQyxDQUFDO0FBQ0wsQ0FBQztBQUVELFNBQVMsWUFBWTtJQUNuQixNQUFNLFdBQVcsR0FBRyxLQUFLLENBQUMsSUFBSSxD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QUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogR2VuZXJhdGUgRkVBVFVSRV9GTEFHUy5tZCwgYSByZXBvcnQgb2YgYWxsIGN1cnJlbnQgZmVhdHVyZSBmbGFnc1xuICovXG5pbXBvcnQgeyBwcm9taXNlcyBhcyBmcyB9IGZyb20gJ2ZzJztcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgKiBhcyBmZWF0cyBmcm9tICcuLi9saWIvZmVhdHVyZXMnO1xuaW1wb3J0IHsgRmxhZ0luZm8sIEZsYWdUeXBlLCBjb21wYXJlVmVyc2lvbnMgfSBmcm9tICcuLi9saWIvcHJpdmF0ZS9mbGFnLW1vZGVsaW5nJztcblxuYXN5bmMgZnVuY3Rpb24gbWFpbigpIHtcbiAgYXdhaXQgdXBkYXRlTWFya2Rvd25GaWxlKHBhdGguam9pbihfX2Rpcm5hbWUsICcuLicsICdGRUFUVVJFX0ZMQUdTLm1kJyksIHtcbiAgICB0YWJsZTogZmxhZ3NUYWJsZSgpLFxuICAgIGRldGFpbHM6IGZsYWdzRGV0YWlscygpLFxuICAgIGpzb246IHJlY29tbWVuZGVkSnNvbigpLFxuICAgIHJlbW92ZWQ6IHJlbW92ZWRGbGFncygpLFxuICAgIGRpZmY6IGNoYW5nZWRGbGFncygpLFxuICAgIG1pZ3JhdGVqc29uOiBtaWdyYXRlSnNvbigpLFxuICB9KTtcbn1cblxuZnVuY3Rpb24gZmxhZ3NUYWJsZSgpIHtcbiAgcmV0dXJuIHJlbmRlclRhYmxlKFtcbiAgICBbJ0ZsYWcnLCAnU3VtbWFyeScsICdTaW5jZScsICdUeXBlJ10sXG4gICAgLi4udjJmbGFncygpLm1hcCgoW25hbWUsIGZsYWddKSA9PlxuICAgICAgW1xuICAgICAgICByZW5kZXJMaW5rKG1kRXNjKG5hbWUpLCBnaXRodWJIZWFkaW5nTGluayhmbGFnRGV0YWlsc0hlYWRpbmcobmFtZSwgZmxhZykpKSxcbiAgICAgICAgZmxhZy5zdW1tYXJ5LFxuICAgICAgICBmbGFnLmludHJvZHVjZWRJbi52MiA/PyAnJyxcbiAgICAgICAgcmVuZGVyVHlwZShmbGFnLnR5cGUpLFxuICAgICAgXSxcbiAgICApLFxuICBdKTtcbn1cblxuZnVuY3Rpb24gcmVtb3ZlZEZsYWdzKCkge1xuICBjb25zdCByZW1vdmVkSW5WMiA9IGZsYWdzKGZsYWcgPT4gZmxhZy5pbnRyb2R1Y2VkSW4udjIgPT09IHVuZGVmaW5lZCAmJiBmbGFnLmludHJvZHVjZWRJbi52MSAhPT0gdW5kZWZpbmVkKTtcblxuICByZXR1cm4gcmVuZGVyVGFibGUoW1xuICAgIFsnRmxhZycsICdTdW1tYXJ5JywgJ1R5cGUnLCAnU2luY2UnXSxcbiAgICAuLi5yZW1vdmVkSW5WMi5tYXAoKFtuYW1lLCBmbGFnXSkgPT4gW1xuICAgICAgcmVuZGVyTGluayhtZEVzYyhuYW1lKSwgZ2l0aHViSGVhZGluZ0xpbmsoZmxhZ0RldGFpbHNIZWFkaW5nKG5hbWUsIGZsYWcpKSksXG4gICAgICBmbGFnLnN1bW1hcnksXG4gICAgICByZW5kZXJUeXBlKGZsYWcudHlwZSksXG4gICAgICBmbGFnLmludHJvZHVjZWRJbi52MSA/PyAnJyxcbiAgICBdKSxcbiAgXSk7XG59XG5cbmZ1bmN0aW9uIGNoYW5nZWRGbGFncygpIHtcbiAgY29uc3QgY2hhbmdlZEluVjIgPSBmbGFncyhmbGFnID0+ICEhZmxhZy5kZWZhdWx0cz8udjIgJiYgISFmbGFnLmludHJvZHVjZWRJbi52Mik7XG5cbiAgcmV0dXJuIHJlbmRlclRhYmxlKFtcbiAgICBbJ0ZsYWcnLCAnU3VtbWFyeScsICdUeXBlJywgJ1NpbmNlJywgJ3YxIGRlZmF1bHQnLCAndjIgZGVmYXVsdCddLFxuICAgIC4uLmNoYW5nZWRJblYyLm1hcCgoW25hbWUsIGZsYWddKSA9PiBbXG4gICAgICByZW5kZXJMaW5rKG1kRXNjKG5hbWUpLCBnaXRodWJIZWFkaW5nTGluayhmbGFnRGV0YWlsc0hlYWRpbmcobmFtZSwgZmxhZykpKSxcbiAgICAgIGZsYWcuc3VtbWFyeSxcbiAgICAgIHJlbmRlclR5cGUoZmxhZy50eXBlKSxcbiAgICAgIGZsYWcuaW50cm9kdWNlZEluLnYxID8/ICcnLFxuICAgICAgcmVuZGVyVmFsdWUoZmFsc2UpLFxuICAgICAgcmVuZGVyVmFsdWUoZmxhZy5kZWZhdWx0cz8udjIpLFxuICAgIF0pLFxuICBdKTtcbn1cblxuZnVuY3Rpb24gbWlncmF0ZUpzb24oKSB7XG4gIGNvbnN0IGNoYW5nZWRJblYyID0gZmxhZ3MoZmxhZyA9PiAhIWZsYWcuZGVmYXVsdHM/LnYyICYmICEhZmxhZy5pbnRyb2R1Y2VkSW4udjIpO1xuXG4gIGNvbnN0IGNvbnRleHQgPSBPYmplY3QuZnJvbUVudHJpZXMoY2hhbmdlZEluVjIubWFwKChbbmFtZSwgX10pID0+IFtuYW1lLCBmYWxzZV0pKTtcblxuICByZXR1cm4gW1xuICAgICdgYGBqc29uJyxcbiAgICBKU09OLnN0cmluZ2lmeSh7IGNvbnRleHQgfSwgdW5kZWZpbmVkLCAyKSxcbiAgICAnYGBgJyxcbiAgXS5qb2luKCdcXG4nKTtcbn1cblxuZnVuY3Rpb24gZmxhZ3NEZXRhaWxzKCkge1xuICBjb25zdCBhbGxGbGFncyA9IGZsYWdzKF8gPT4gdHJ1ZSk7XG5cbiAgcmV0dXJuIGFsbEZsYWdzLmZsYXRNYXAoKFtuYW1lLCBmbGFnXSkgPT4gW1xuICAgIGAjIyMgJHtmbGFnRGV0YWlsc0hlYWRpbmcobmFtZSwgZmxhZyl9YCxcbiAgICAnJyxcbiAgICBgKiR7ZmxhZy5zdW1tYXJ5fSogJHtyZW5kZXJUeXBlKGZsYWcudHlwZSl9YCxcbiAgICAnJyxcbiAgICBkZWRlbnQoZmxhZy5kZXRhaWxzTWQpLFxuICAgICcnLFxuICAgIHJlbmRlclRhYmxlKFtcbiAgICAgIFsnU2luY2UnLCAnRGVmYXVsdCcsICdSZWNvbW1lbmRlZCddLFxuXG4gICAgICAvLyBWMVxuICAgICAgZmxhZy5pbnRyb2R1Y2VkSW4udjFcbiAgICAgICAgPyBbZmxhZy5pbnRyb2R1Y2VkSW4udjEsIHJlbmRlclZhbHVlKGZhbHNlKSwgcmVuZGVyVmFsdWUoZmxhZy5yZWNvbW1lbmRlZFZhbHVlKV1cbiAgICAgICAgOiBbJyhub3QgaW4gdjEpJywgJycsICcnXSxcblxuICAgICAgLy8gVjJcbiAgICAgIGZsYWcuaW50cm9kdWNlZEluLnYyXG4gICAgICAgID8gW2ZsYWcuaW50cm9kdWNlZEluLnYyLCByZW5kZXJWYWx1ZShmbGFnLmRlZmF1bHRzPy52MiA/PyBmYWxzZSksIHJlbmRlclZhbHVlKGZsYWcucmVjb21tZW5kZWRWYWx1ZSldXG4gICAgICAgIDogZmxhZy5kZWZhdWx0cz8udjIgIT09IHVuZGVmaW5lZFxuICAgICAgICAgID8gWycoZGVmYXVsdCBpbiB2MiknLCByZW5kZXJWYWx1ZShmbGFnLmRlZmF1bHRzPy52MiksICcnXVxuICAgICAgICAgIDogWycobm90IGluIHYyKScsICcnLCAnJ10sXG4gICAgXSksXG4gICAgLi4ub2xkQmVoYXZpb3IoZmxhZykgPyBbXG4gICAgICBgKipDb21wYXRpYmlsaXR5IHdpdGggb2xkIGJlaGF2aW9yOioqICR7b2xkQmVoYXZpb3IoZmxhZyl9YCxcbiAgICAgICcnLFxuICAgIF0gOiBbXSxcbiAgICAnJyxcbiAgXSkuam9pbignXFxuJyk7XG59XG5cbmZ1bmN0aW9uIG9sZEJlaGF2aW9yKGZsYWc6IEZsYWdJbmZvKTogc3RyaW5nIHwgdW5kZWZpbmVkIHtcbiAgc3dpdGNoIChmbGFnLnR5cGUpIHtcbiAgICBjYXNlIEZsYWdUeXBlLkFwaURlZmF1bHQ6IHJldHVybiBmbGFnLmNvbXBhdGliaWxpdHlXaXRoT2xkQmVoYXZpb3JNZDtcbiAgICBjYXNlIEZsYWdUeXBlLkJ1Z0ZpeDogcmV0dXJuIGZsYWcuY29tcGF0aWJpbGl0eVdpdGhPbGRCZWhhdmlvck1kO1xuICAgIGNhc2UgRmxhZ1R5cGUuVmlzaWJsZUNvbnRleHQ6IHJldHVybiB1bmRlZmluZWQ7XG4gIH1cbn1cblxuZnVuY3Rpb24gcmVjb21tZW5kZWRKc29uKCkge1xuICByZXR1cm4gW1xuICAgICdgYGBqc29uJyxcbiAgICBKU09OLnN0cmluZ2lmeSh7IGNvbnRleHQ6IGZlYXRzLk5FV19QUk9KRUNUX0NPTlRFWFQgfSwgdW5kZWZpbmVkLCAyKSxcbiAgICAnYGBgJyxcbiAgXS5qb2luKCdcXG4nKTtcbn1cblxuZnVuY3Rpb24gdjJmbGFncygpIHtcbiAgcmV0dXJuIGZsYWdzKGZsYWcgPT4gZmxhZy5pbnRyb2R1Y2VkSW4udjIgIT09IHVuZGVmaW5lZCk7XG59XG5cbmZ1bmN0aW9uIGZsYWdzKHByZWQ6ICh4OiBGbGFnSW5mbykgPT4gYm9vbGVhbikge1xuICBjb25zdCBlbnRyaWVzID0gT2JqZWN0LmVudHJpZXMoZmVhdHMuRkxBR1MpXG4gICAgLmZpbHRlcigoW18sIGZsYWddKSA9PiBwcmVkKGZsYWcpKTtcblxuICBlbnRyaWVzLnNvcnQoKGEsIGIpID0+IGZpcnN0Q21wKFxuICAgIC8vIFNvcnQgYnkgdmVyc2lvbnMgZmlyc3RcbiAgICBjb21wYXJlVmVyc2lvbnMoYVsxXS5pbnRyb2R1Y2VkSW4udjIsIGJbMV0uaW50cm9kdWNlZEluLnYyKSxcbiAgICBjb21wYXJlVmVyc2lvbnMoYVsxXS5pbnRyb2R1Y2VkSW4udjEsIGJbMV0uaW50cm9kdWNlZEluLnYxKSxcbiAgICAvLyBUaGVuIHNvcnQgYnkgbmFtZVxuICAgIGFbMF0ubG9jYWxlQ29tcGFyZShiWzBdKSkpO1xuXG4gIHJldHVybiBlbnRyaWVzO1xufVxuXG5mdW5jdGlvbiByZW5kZXJUeXBlKHR5cGU6IEZsYWdUeXBlKTogc3RyaW5nIHtcbiAgc3dpdGNoICh0eXBlKSB7XG4gICAgY2FzZSBGbGFnVHlwZS5BcGlEZWZhdWx0OiByZXR1cm4gJyhkZWZhdWx0KSc7XG4gICAgY2FzZSBGbGFnVHlwZS5CdWdGaXg6IHJldHVybiAnKGZpeCknO1xuICAgIGNhc2UgRmxhZ1R5cGUuVmlzaWJsZUNvbnRleHQ6IHJldHVybiAnKGNvbmZpZyknO1xuICB9XG59XG5cbmZ1bmN0aW9uIHJlbmRlclRhYmxlKHJvd3M6IHN0cmluZ1tdW10pIHtcbiAgcmV0dXJuIFtcbiAgICAnJyxcbiAgICAnfCAnICsgcm93c1swXS5qb2luKCcgfCAnKSArICcgfCcsXG4gICAgJ3wgJyArIHJvd3NbMF0ubWFwKF8gPT4gJy0tLS0tJykuam9pbignIHwgJykgKyAnIHwnLFxuICAgIC4uLnJvd3Muc2xpY2UoMSkubWFwKHJvdyA9PiAnfCAnICsgcm93LmpvaW4oJyB8ICcpICsgJyB8JyksXG4gICAgJycsXG4gIF0uam9pbignXFxuJyk7XG59XG5cbi8qKlxuICogUmV0dXJuIHRoZSBoZWFkaW5nIHRoYXQgd2lsbCBiZSB1c2VkIHRvIGNhcHRpb24gdGhpcyBmbGFnJ3MgZGV0YWlsc1xuICovXG5mdW5jdGlvbiBmbGFnRGV0YWlsc0hlYWRpbmcobmFtZTogc3RyaW5nLCBfOiBGbGFnSW5mbykge1xuICByZXR1cm4gbmFtZTtcbn1cblxuLyoqXG4gKiBSZXR1cm4gYSBsaW5rIHRoYXQgaXMgdmFsaWQgb24gR2l0SHViIHRvIHJlZmVyIHRvIGEgaGVhZGluZ1xuICovXG5mdW5jdGlvbiBnaXRodWJIZWFkaW5nTGluayhoZWFkaW5nOiBzdHJpbmcpIHtcbiAgcmV0dXJuIGAjJHtoZWFkaW5nLnRvTG93ZXJDYXNlKCkucmVwbGFjZSgvIC9nLCAnLScpLnJlcGxhY2UoL1teYS16MC05Xy1dL2csICcnKX1gO1xufVxuXG4vKipcbiAqIFJlbW92ZSBzaGFyZWQgbGVhZGluZyB3aGl0ZXNwYWNlIGZyb20gYWxsIG5vbi1lbXB0eSBsaW5lc1xuICovXG5mdW5jdGlvbiBkZWRlbnQoYm9keTogc3RyaW5nKSB7XG4gIGNvbnN0IGxpbmVzID0gYm9keS5zcGxpdCgnXFxuJykuZmlsdGVyKCh4KSA9PiB4LnRyaW0oKSAhPT0gJycpO1xuICBjb25zdCBsZWFkaW5nV3MgPSBsaW5lcy5tYXAoeCA9PiB4Lm1hdGNoKC9eICovKT8uWzBdLmxlbmd0aCA/PyAwKTtcbiAgY29uc3Qgc2hhcmVkV3MgPSBNYXRoLm1pbiguLi5sZWFkaW5nV3MpO1xuICBjb25zdCByZSA9IG5ldyBSZWdFeHAoJ14nICsgJyAnLnJlcGVhdChzaGFyZWRXcyksICdtZycpO1xuICByZXR1cm4gYm9keS5yZXBsYWNlKHJlLCAnJykudHJpbSgpO1xufVxuXG5mdW5jdGlvbiByZW5kZXJWYWx1ZSh4OiBhbnkpIHtcbiAgcmV0dXJuIGBcXGAke0pTT04uc3RyaW5naWZ5KHgpfVxcYGA7XG59XG5cbmZ1bmN0aW9uIHJlbmRlckxpbmsoY2FwdGlvbjogc3RyaW5nLCBsaW5rOiBzdHJpbmcpIHtcbiAgcmV0dXJuIGBbJHtjYXB0aW9ufV0oJHtsaW5rfSlgO1xufVxuXG5mdW5jdGlvbiBtZEVzYyh4OiBzdHJpbmcpIHtcbiAgcmV0dXJuIHgucmVwbGFjZSgvXy9nLCAnXFxcXF8nKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gdXBkYXRlTWFya2Rvd25GaWxlKGZpbGVuYW1lOiBzdHJpbmcsIHNlY3Rpb25zOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+KSB7XG4gIGxldCBjb250ZW50cyA9IGF3YWl0IGZzLnJlYWRGaWxlKGZpbGVuYW1lLCB7IGVuY29kaW5nOiAndXRmLTgnIH0pO1xuXG4gIGZvciAoY29uc3QgW3NlY3Rpb24sIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhzZWN0aW9ucykpIHtcbiAgICBjb25zdCByZSA9IG5ldyBSZWdFeHAoYDwhLS0gQkVHSU4gJHtzZWN0aW9ufSAtLT4oLiopPCEtLSBFTkQgJHtzZWN0aW9ufSAtLT5gLCAncycpO1xuICAgIGNvbnRlbnRzID0gY29udGVudHMucmVwbGFjZShyZSwgYDwhLS0gQkVHSU4gJHtzZWN0aW9ufSAtLT5cXG4ke3ZhbHVlfVxcbjwhLS0gRU5EICR7c2VjdGlvbn0gLS0+YCk7XG4gIH1cblxuICBhd2FpdCBmcy53cml0ZUZpbGUoZmlsZW5hbWUsIGNvbnRlbnRzLCB7IGVuY29kaW5nOiAndXRmLTgnIH0pO1xufVxuXG5mdW5jdGlvbiBmaXJzdENtcCguLi54czogbnVtYmVyW10pIHtcbiAgcmV0dXJuIHhzLmZpbmQoeCA9PiB4ICE9PSAwKSA/PyAwO1xufVxuXG5tYWluKCkuY2F0Y2goZSA9PiB7XG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1jb25zb2xlXG4gIGNvbnNvbGUuZXJyb3IoZSk7XG4gIHByb2Nlc3MuZXhpdENvZGUgPSAxO1xufSk7Il19